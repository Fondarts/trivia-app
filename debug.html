<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Quizle</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a2e; 
            color: #fff; 
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        .log {
            padding: 5px;
            margin: 2px 0;
            background: #0f3460;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #e94560;
            color: white;
            cursor: pointer;
        }
        select {
            padding: 8px;
            margin: 5px;
            background: #0f3460;
            color: white;
            border: 1px solid #2196f3;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Debug - Sistema de Categorías</h1>
    
    <div class="debug-section">
        <h3>1. Test Básico del Banco</h3>
        <button onclick="testBasicBank()">Test Banco Básico</button>
        <div id="bank-log"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. Test de Carga de Packs</h3>
        <button onclick="testLoadPacks()">Cargar Packs ES</button>
        <button onclick="testLoadPacksEN()">Cargar Packs EN</button>
        <div id="packs-log"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Test de Select de Categorías</h3>
        <button onclick="testCategorySelect()">Crear Select</button>
        <select id="test-category-select">
            <option value="">-- Selecciona --</option>
        </select>
        <div id="select-log"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. Test Completo</h3>
        <button onclick="testComplete()">Test Completo</button>
        <div id="complete-log"></div>
    </div>

    <script>
        // Función de log helper
        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(log);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // 1. Test básico del banco
        function testBasicBank() {
            const logId = 'bank-log';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'Iniciando test del banco...', 'info');
            
            // Crear un banco vacío
            const emptyBank = {
                movies: [],
                geography: [],
                history: [],
                science: [],
                sports: [],
                anime: []
            };
            
            // Guardar en localStorage
            try {
                localStorage.setItem('trivia_bank', JSON.stringify(emptyBank));
                addLog(logId, 'Banco vacío guardado en localStorage', 'success');
                
                // Recuperar y verificar
                const retrieved = localStorage.getItem('trivia_bank');
                const parsed = JSON.parse(retrieved);
                addLog(logId, `Categorías en el banco: ${Object.keys(parsed).join(', ')}`, 'success');
                
                // Agregar algunas preguntas de prueba
                parsed.movies.push({
                    q: "¿Pregunta de prueba?",
                    options: ["A", "B", "C", "D"],
                    answer: 0,
                    difficulty: "easy",
                    category: "movies"
                });
                
                localStorage.setItem('trivia_bank', JSON.stringify(parsed));
                addLog(logId, 'Pregunta de prueba agregada', 'success');
                
            } catch (error) {
                addLog(logId, `Error: ${error.message}`, 'error');
            }
        }

        // 2. Test de carga de packs
        async function testLoadPacks() {
            const logId = 'packs-log';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'Cargando packs en español...', 'info');
            
            try {
                // Primero cargar el manifest
                const manifestUrl = 'packs/es/manifest.json';
                addLog(logId, `Cargando manifest desde: ${manifestUrl}`, 'info');
                
                const response = await fetch(manifestUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} al cargar ${manifestUrl}`);
                }
                
                const manifest = await response.json();
                addLog(logId, `Manifest cargado. ${manifest.packs?.length || 0} packs encontrados`, 'success');
                
                // Crear banco vacío
                const bank = {
                    movies: [],
                    geography: [],
                    history: [],
                    science: [],
                    sports: [],
                    anime: []
                };
                
                // Cargar cada pack
                for (const pack of manifest.packs || []) {
                    addLog(logId, `Procesando pack: ${pack.category}`, 'info');
                    
                    for (const file of pack.files || []) {
                        const fileUrl = `packs/es/${file}`;
                        try {
                            const fileResponse = await fetch(fileUrl);
                            if (!fileResponse.ok) {
                                addLog(logId, `Error cargando ${file}: HTTP ${fileResponse.status}`, 'warning');
                                continue;
                            }
                            
                            const questions = await fileResponse.json();
                            const validQuestions = questions.filter(q => 
                                q && q.q && Array.isArray(q.options) && q.options.length === 4
                            );
                            
                            if (!bank[pack.category]) {
                                bank[pack.category] = [];
                            }
                            
                            bank[pack.category].push(...validQuestions.map(q => ({
                                q: q.q,
                                options: q.options,
                                answer: q.answer || 0,
                                difficulty: q.difficulty || 'medium',
                                category: pack.category
                            })));
                            
                            addLog(logId, `✓ ${file}: ${validQuestions.length} preguntas agregadas`, 'success');
                            
                        } catch (error) {
                            addLog(logId, `Error procesando ${file}: ${error.message}`, 'error');
                        }
                    }
                }
                
                // Guardar banco
                localStorage.setItem('trivia_bank', JSON.stringify(bank));
                
                // Resumen
                const totalQuestions = Object.values(bank).reduce((sum, cat) => sum + cat.length, 0);
                addLog(logId, `TOTAL: ${totalQuestions} preguntas en ${Object.keys(bank).length} categorías`, 'success');
                
                Object.entries(bank).forEach(([cat, questions]) => {
                    if (questions.length > 0) {
                        addLog(logId, `  • ${cat}: ${questions.length} preguntas`, 'info');
                    }
                });
                
            } catch (error) {
                addLog(logId, `Error general: ${error.message}`, 'error');
            }
        }

        async function testLoadPacksEN() {
            const logId = 'packs-log';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'Cargando packs en inglés...', 'info');
            
            try {
                const manifestUrl = 'packs/en/manifest.json';
                const response = await fetch(manifestUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const manifest = await response.json();
                addLog(logId, `Manifest EN cargado. ${manifest.packs?.length || 0} packs`, 'success');
                
            } catch (error) {
                addLog(logId, `Error: ${error.message}`, 'error');
            }
        }

        // 3. Test del select de categorías
        function testCategorySelect() {
            const logId = 'select-log';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'Creando select de categorías...', 'info');
            
            try {
                const select = document.getElementById('test-category-select');
                select.innerHTML = '';
                
                // Opción por defecto
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Selecciona categoría --';
                select.appendChild(defaultOption);
                
                // Opción todas
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'Todas las categorías';
                select.appendChild(allOption);
                
                // Cargar banco
                const bank = JSON.parse(localStorage.getItem('trivia_bank') || '{}');
                
                // Agregar categorías con preguntas
                const categoriesWithQuestions = Object.entries(bank)
                    .filter(([cat, questions]) => questions && questions.length > 0)
                    .map(([cat, questions]) => ({
                        key: cat,
                        label: cat.charAt(0).toUpperCase() + cat.slice(1),
                        count: questions.length
                    }));
                
                if (categoriesWithQuestions.length === 0) {
                    addLog(logId, 'No hay categorías con preguntas', 'warning');
                    return;
                }
                
                // Crear grupo de categorías base
                const baseGroup = document.createElement('optgroup');
                baseGroup.label = 'Categorías Base';
                
                categoriesWithQuestions.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.key;
                    option.textContent = `${cat.label} (${cat.count} preguntas)`;
                    baseGroup.appendChild(option);
                    addLog(logId, `Agregada: ${cat.label} con ${cat.count} preguntas`, 'success');
                });
                
                select.appendChild(baseGroup);
                
                addLog(logId, `Select creado con ${categoriesWithQuestions.length} categorías`, 'success');
                
            } catch (error) {
                addLog(logId, `Error: ${error.message}`, 'error');
            }
        }

        // 4. Test completo
        async function testComplete() {
            const logId = 'complete-log';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, '=== INICIANDO TEST COMPLETO ===', 'info');
            
            // Paso 1: Limpiar localStorage
            addLog(logId, 'Paso 1: Limpiando localStorage...', 'info');
            localStorage.removeItem('trivia_bank');
            localStorage.removeItem('trivia_custom');
            localStorage.removeItem('trivia_settings');
            addLog(logId, '✓ localStorage limpio', 'success');
            
            // Paso 2: Cargar packs
            addLog(logId, 'Paso 2: Cargando packs...', 'info');
            await testLoadPacks();
            
            // Paso 3: Verificar banco
            addLog(logId, 'Paso 3: Verificando banco...', 'info');
            const bank = JSON.parse(localStorage.getItem('trivia_bank') || '{}');
            const totalQuestions = Object.values(bank).reduce((sum, cat) => sum + cat.length, 0);
            
            if (totalQuestions > 0) {
                addLog(logId, `✓ Banco verificado: ${totalQuestions} preguntas`, 'success');
            } else {
                addLog(logId, '✗ El banco está vacío', 'error');
                return;
            }
            
            // Paso 4: Crear select
            addLog(logId, 'Paso 4: Creando select...', 'info');
            testCategorySelect();
            
            // Paso 5: Test de buildDeck
            addLog(logId, 'Paso 5: Probando buildDeck...', 'info');
            
            // Crear función buildDeckSingle simple
            window.buildDeckSingle = function(categoryKey, count, difficulty) {
                const bank = JSON.parse(localStorage.getItem('trivia_bank') || '{}');
                let pool = [];
                
                if (categoryKey === 'all') {
                    Object.values(bank).forEach(questions => {
                        pool.push(...(questions || []));
                    });
                } else if (bank[categoryKey]) {
                    pool = [...bank[categoryKey]];
                }
                
                // Mezclar y tomar las necesarias
                const shuffled = pool.sort(() => Math.random() - 0.5);
                return shuffled.slice(0, Math.min(count, shuffled.length));
            };
            
            try {
                const testDeck = window.buildDeckSingle('movies', 5, 'easy');
                addLog(logId, `✓ Deck creado: ${testDeck.length} preguntas`, 'success');
                
                if (testDeck.length > 0) {
                    addLog(logId, `Primera pregunta: "${testDeck[0].q}"`, 'info');
                }
            } catch (error) {
                addLog(logId, `✗ Error creando deck: ${error.message}`, 'error');
            }
            
            addLog(logId, '=== TEST COMPLETO FINALIZADO ===', 'success');
        }
        
        // Auto-ejecutar test básico al cargar
        window.addEventListener('load', () => {
            console.log('Debug page loaded');
            testBasicBank();
        });
    </script>
</body>
</html>