<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Amistades - Trivia</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #555;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        input {
            padding: 8px;
            margin: 5px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug de Amistades - Trivia</h1>
    
    <div class="section">
        <h2>Usuario Actual</h2>
        <div id="currentUser"></div>
        <button onclick="loadCurrentUser()">Recargar Usuario</button>
    </div>
    
    <div class="section">
        <h2>Mis Amistades</h2>
        <div id="friendships"></div>
        <button onclick="loadFriendships()">Recargar Amistades</button>
        <button onclick="fixBidirectional()">Arreglar Bidireccionales</button>
    </div>
    
    <div class="section">
        <h2>Solicitudes Pendientes</h2>
        <div id="pendingRequests"></div>
        <button onclick="loadPendingRequests()">Recargar Solicitudes</button>
    </div>
    
    <div class="section">
        <h2>Herramientas</h2>
        <div>
            <h3>Crear Amistad Manual</h3>
            <input type="text" id="friendId" placeholder="ID del amigo">
            <button onclick="createFriendship()">Crear Amistad Bidireccional</button>
        </div>
        <div>
            <h3>Buscar Usuario</h3>
            <input type="text" id="searchNickname" placeholder="Nickname a buscar">
            <button onclick="searchUser()">Buscar</button>
            <div id="searchResults"></div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let currentUserId = null;
        
        // Inicializar Supabase
        async function initSupabase() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js';
            document.head.appendChild(script);
            
            await new Promise(resolve => script.onload = resolve);
            
            supabaseClient = window.supabase.createClient(
                'https://fpjkdibubjdbskthofdp.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwamtkaWJ1YmpkYnNrdGhvZmRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzI5NzIsImV4cCI6MjA3MDMwODk3Mn0.oYN5p3Mh_8omCGlCfVApRY_YCG-fFW5MWdeuYsNLgHc'
            );
            
            console.log('Supabase inicializado');
            loadCurrentUser();
        }
        
        async function loadCurrentUser() {
            const container = document.getElementById('currentUser');
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error || !user) {
                    container.innerHTML = '<div class="error">No autenticado</div>';
                    return;
                }
                
                currentUserId = user.id;
                
                const { data: profile } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                container.innerHTML = `
                    <div class="info">
                        <strong>ID:</strong> ${user.id}<br>
                        <strong>Email:</strong> ${user.email || 'N/A'}<br>
                        <strong>Nickname:</strong> ${profile?.nickname || 'Sin nickname'}<br>
                        <strong>Nivel:</strong> ${profile?.level || 1}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function loadFriendships() {
            const container = document.getElementById('friendships');
            
            if (!currentUserId) {
                container.innerHTML = '<div class="error">Primero carga el usuario actual</div>';
                return;
            }
            
            try {
                // Cargar todas las relaciones donde aparezco
                const { data: friendships, error } = await supabaseClient
                    .from('friendships')
                    .select('*')
                    .or(`user_id.eq.${currentUserId},friend_id.eq.${currentUserId}`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!friendships || friendships.length === 0) {
                    container.innerHTML = '<div class="warning">No tienes amistades</div>';
                    return;
                }
                
                // Obtener IDs √∫nicos de amigos
                const friendIds = [...new Set(friendships.map(f => 
                    f.user_id === currentUserId ? f.friend_id : f.user_id
                ))];
                
                // Obtener perfiles
                const { data: profiles } = await supabaseClient
                    .from('user_profiles')
                    .select('user_id, nickname')
                    .in('user_id', friendIds);
                
                const profileMap = {};
                (profiles || []).forEach(p => {
                    profileMap[p.user_id] = p.nickname || 'Sin nickname';
                });
                
                // Crear tabla
                let html = '<table><thead><tr>';
                html += '<th>Direcci√≥n</th><th>Usuario</th><th>Amigo</th><th>Estado</th><th>Fecha</th>';
                html += '</tr></thead><tbody>';
                
                friendships.forEach(f => {
                    const isOutgoing = f.user_id === currentUserId;
                    const friendId = isOutgoing ? f.friend_id : f.user_id;
                    const friendName = profileMap[friendId] || 'Usuario';
                    
                    html += '<tr>';
                    html += `<td>${isOutgoing ? '‚Üí Saliente' : '‚Üê Entrante'}</td>`;
                    html += `<td>${isOutgoing ? 'Yo' : friendName}</td>`;
                    html += `<td>${isOutgoing ? friendName : 'Yo'}</td>`;
                    html += `<td class="${f.status === 'accepted' ? 'success' : 'warning'}">${f.status}</td>`;
                    html += `<td>${new Date(f.created_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                // Verificar bidireccionalidad
                const acceptedFriends = friendships
                    .filter(f => f.status === 'accepted' && f.user_id === currentUserId)
                    .map(f => f.friend_id);
                
                let unidirectional = 0;
                acceptedFriends.forEach(friendId => {
                    const hasReverse = friendships.some(f => 
                        f.user_id === friendId && 
                        f.friend_id === currentUserId && 
                        f.status === 'accepted'
                    );
                    if (!hasReverse) unidirectional++;
                });
                
                if (unidirectional > 0) {
                    html = `<div class="warning">‚ö†Ô∏è Hay ${unidirectional} amistades unidireccionales</div>` + html;
                } else {
                    html = `<div class="success">‚úÖ Todas las amistades son bidireccionales</div>` + html;
                }
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function loadPendingRequests() {
            const container = document.getElementById('pendingRequests');
            
            if (!currentUserId) {
                container.innerHTML = '<div class="error">Primero carga el usuario actual</div>';
                return;
            }
            
            try {
                // Solicitudes recibidas
                const { data: received } = await supabaseClient
                    .from('friendships')
                    .select('*')
                    .eq('friend_id', currentUserId)
                    .eq('status', 'pending');
                
                // Solicitudes enviadas
                const { data: sent } = await supabaseClient
                    .from('friendships')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('status', 'pending');
                
                let html = '<h3>Solicitudes Recibidas</h3>';
                if (received && received.length > 0) {
                    html += '<ul>';
                    for (const req of received) {
                        const { data: profile } = await supabaseClient
                            .from('user_profiles')
                            .select('nickname')
                            .eq('user_id', req.user_id)
                            .single();
                        
                        html += `<li>${profile?.nickname || 'Usuario'} (${req.user_id})</li>`;
                    }
                    html += '</ul>';
                } else {
                    html += '<div class="info">No hay solicitudes recibidas</div>';
                }
                
                html += '<h3>Solicitudes Enviadas</h3>';
                if (sent && sent.length > 0) {
                    html += '<ul>';
                    for (const req of sent) {
                        const { data: profile } = await supabaseClient
                            .from('user_profiles')
                            .select('nickname')
                            .eq('user_id', req.friend_id)
                            .single();
                        
                        html += `<li>${profile?.nickname || 'Usuario'} (${req.friend_id})</li>`;
                    }
                    html += '</ul>';
                } else {
                    html += '<div class="info">No hay solicitudes enviadas</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        async function fixBidirectional() {
            if (!currentUserId) {
                alert('Primero carga el usuario actual');
                return;
            }
            
            try {
                // Obtener amistades aceptadas salientes
                const { data: outgoing } = await supabaseClient
                    .from('friendships')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('status', 'accepted');
                
                let fixed = 0;
                
                for (const friendship of outgoing || []) {
                    // Verificar si existe la relaci√≥n inversa
                    const { data: reverse } = await supabaseClient
                        .from('friendships')
                        .select('id')
                        .eq('user_id', friendship.friend_id)
                        .eq('friend_id', currentUserId)
                        .single();
                    
                    if (!reverse) {
                        // Crear la relaci√≥n inversa
                        const { error } = await supabaseClient
                            .from('friendships')
                            .insert({
                                user_id: friendship.friend_id,
                                friend_id: currentUserId,
                                status: 'accepted'
                            });
                        
                        if (!error) fixed++;
                    }
                }
                
                alert(`Se arreglaron ${fixed} amistades`);
                loadFriendships();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function createFriendship() {
            const friendId = document.getElementById('friendId').value.trim();
            
            if (!friendId || !currentUserId) {
                alert('Ingresa un ID v√°lido');
                return;
            }
            
            try {
                // Crear en ambas direcciones
                await supabaseClient
                    .from('friendships')
                    .insert([
                        {
                            user_id: currentUserId,
                            friend_id: friendId,
                            status: 'accepted'
                        },
                        {
                            user_id: friendId,
                            friend_id: currentUserId,
                            status: 'accepted'
                        }
                    ]);
                
                alert('Amistad creada');
                loadFriendships();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function searchUser() {
            const nickname = document.getElementById('searchNickname').value.trim();
            const container = document.getElementById('searchResults');
            
            if (!nickname) {
                container.innerHTML = '<div class="error">Ingresa un nickname</div>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('user_id, nickname, level')
                    .ilike('nickname', `%${nickname}%`)
                    .limit(10);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="warning">No se encontraron usuarios</div>';
                    return;
                }
                
                let html = '<table><thead><tr><th>ID</th><th>Nickname</th><th>Nivel</th></tr></thead><tbody>';
                data.forEach(user => {
                    html += `<tr>`;
                    html += `<td>${user.user_id}</td>`;
                    html += `<td>${user.nickname}</td>`;
                    html += `<td>${user.level}</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table>';
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Inicializar al cargar
        initSupabase();
    </script>
</body>
</html>