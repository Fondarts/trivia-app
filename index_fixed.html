<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>Quizle!</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
  
  <!-- CSS Optimizado y Consolidado v3.0 -->
  <link rel="stylesheet" href="./css/main.css?v=3.0">
  <link rel="stylesheet" href="./css/profile.css?v=3.0">
  <link rel="stylesheet" href="./css/achievements.css?v=3.0">
  <link rel="stylesheet" href="./css/adventure.css?v=3.0">
  
  <script>
    // Debug helper
    console.log('=== QUIZLE INICIANDO (v3.2 Fixed) ===');
    
    // Crear funciones dummy para evitar errores mientras se cargan los módulos
    window.toast = window.toast || function(msg) { console.log('Toast:', msg); };
    window.updatePlayerXPBar = window.updatePlayerXPBar || function() {};
    window.startSolo = window.startSolo || function() { console.log('startSolo llamado pero no listo'); };
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="app-title">Quizle!</div>
      <div class="row">
        <button class="iconbtn" id="btnDLC" title="Tienda de packs">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 7V6a5 5 0 0 1 10 0v1h3a1 1 0 0 1 .98 1.197l-2 10A2 2 0 0 1 17 20H7a2 2 0 0 1-1.98-1.803l-2-10A1 1 0 0 1 4 7h3Zm2 0h6V6a3 3 0 0 0-6 0v1Z"></path></svg>
        </button>
        <button class="iconbtn avatar-btn" id="btnProfile" aria-label="Perfil de Usuario">
          <img src="img/avatar_placeholder.svg" alt="Avatar"/>
        </button>
      </div>
    </div>

    <div class="card" id="configCard">
      <!-- Sección de Login/Registro (solo visible cuando NO está logueado) -->
      <div class="section" id="authSection">
        <div class="auth-prompt">
          <p style="text-align:center; margin: 0 0 12px; color: var(--muted); font-size: 14px;">
            🎮 Crea una cuenta para guardar tu progreso y competir con amigos
          </p>
          <button class="btn accent" id="btnShowAuth" type="button">
            <span style="font-size: 16px;">👤</span> Iniciar Sesión / Registrarse
          </button>
        </div>
      </div>
      
      <!-- Mensaje de bienvenida para usuarios logueados sin nickname -->
      <div class="section" id="welcomeSection" style="display:none">
        <div class="welcome-box">
          <p style="text-align:center; margin: 0; font-weight: 600;">🎮 ¡Bienvenido a Quizle!</p>
          <p style="text-align:center; margin: 8px 0 0; color: var(--muted); font-size: 14px;">Configura tu nickname en tu perfil para empezar a jugar</p>
        </div>
      </div>
      
      <!-- Sección de nombre temporal (solo para usuarios NO logueados) -->
      <div class="section" id="guestNameSection">
        <label data-i18n="yourName">Tu nombre</label>
        <input id="playerName" class="input" data-i18n-placeholder="yourNamePlaceholder" placeholder="Tu nombre"/>
      </div>

      <div class="section">
        <label data-i18n="mode">Modo</label>
        <div class="segment" id="modeSeg">
          <div class="seg active" data-val="rounds" data-i18n="modeSolo">SOLO</div>
          <div class="seg" data-val="timed" data-i18n="modeTimed">CONTRARRELOJ</div>
          <div class="seg" data-val="vs" data-i18n="modeVS">VS</div>
          <div class="seg" data-val="adventure" data-i18n="modeAdventure">AVENTURA</div>
        </div>
      </div>

      <div class="section" id="roundsWrap">
        <label data-i18n="questionsCount">Cantidad de preguntas</label>
        <select id="rounds" class="input">
          <option value="5">5</option>
          <option value="15" selected>15</option>
          <option value="30">30</option>
        </select>
      </div>

      <div class="section" id="timeWrap" style="display:none">
        <label data-i18n="time">Tiempo</label>
        <select id="timer" class="input">
          <option value="15">15s</option>
          <option value="30" selected>30s</option>
          <option value="60">1m</option>
          <option value="180">3m</option>
        </select>
      </div>
      
      <div class="section" id="vsSection" style="display:none">
        <div class="segment two" id="vsModeToggle">
          <div class="seg active" data-val="host" data-i18n="create">CREAR</div>
          <div class="seg" data-val="join" data-i18n="join">UNIRSE</div>
        </div>
      </div>

      <div class="section" id="vsRoundsWrap" style="display:none">
        <label data-i18n="questionsCount">Cantidad de preguntas</label>
        <select id="vsRounds" class="input">
          <option value="5">5</option>
          <option value="15" selected>15</option>
          <option value="30">30</option>
        </select>
      </div>

      <div class="section" id="diffSection">
        <label data-i18n="difficulty">Dificultad</label>
        <div class="pills" id="diffPills">
          <div class="pill" data-val="any" data-i18n="difficultyAny">Cualquiera</div>
          <div class="pill active" data-val="easy" data-i18n="difficultyEasy">Fácil</div>
          <div class="pill" data-val="medium" data-i18n="difficultyMedium">Medio</div>
          <div class="pill" data-val="hard" data-i18n="difficultyHard">Difícil</div>
        </div>
      </div>

      <div class="section" id="catSection">
        <label data-i18n="category">Categoría</label>
        <select id="categorySel" class="input">
          <!-- Se llenará dinámicamente -->
          <option value="">Cargando categorías...</option>
        </select>
      </div>

      <div class="section" id="spStartWrap">
        <button class="btn" id="btnStart" type="button" data-i18n="start">EMPEZAR</button>
      </div>

      <div class="section" id="vsActionArea" style="display:none">
        <div id="vsHostActions">
          <button class="btn" id="btnVsHost" type="button" data-i18n="createRoom">Crear sala</button>
          <div class="row" id="vsHostExtras" style="justify-content:space-between; gap:8px;margin-top:8px">
            <span class="badge code" id="vsCodeBadge" style="flex:1"><span data-i18n="room">Sala</span>: —</span>
            <button class="btn secondary small" id="btnShareCode" type="button" style="min-width:120px" data-i18n="share">Compartir</button>
          </div>
        </div>
        <div id="vsJoinActions" style="display:none">
          <input id="inputVsCode" class="input" data-i18n-placeholder="roomCode" placeholder="Código de sala"/>
          <button class="btn secondary" id="btnVsJoin" type="button" data-i18n="joinRoom">Unirse</button>
        </div>
      </div>
      
      <div class="section navigation-buttons">
        <div class="row" style="margin-top:10px">
          <button class="btn secondary" id="btnOpenLB" type="button" style="flex:1" data-i18n="leaderboards">Leaderboards</button>
          <button class="btn secondary" id="btnOpenStats" type="button" style="flex:1" data-i18n="statistics">Estadísticas</button>
        </div>
      </div>
    </div>

    <div class="card" id="gameArea" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <div class="badge" id="bMeta" data-i18n="question">Pregunta</div>
          <div class="badge" id="bCat">—</div>
          <div class="badge" id="bDiff">—</div>
        </div>
      </div>
      <div id="qMedia" class="qMedia" style="display:none"><img alt="imagen"/></div>
      <div id="qText" style="font-size:20px;font-weight:800; margin-top: 8px;">—</div>
      <div id="options" class="options" style="margin-top: 8px;"></div>
      <div class="progress" style="margin-top: 8px;"><div id="progressBar"></div></div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div class="badge" id="kHUD">0/0 · 0 <span data-i18n="pts">pts</span></div>
        <button class="btn" id="btnNext" type="button" style="display:none;width:auto;min-width:140px" data-i18n="next">Siguiente</button>
      </div>
      <button class="btn secondary danger" id="btnExitGame" type="button" style="margin-top: 10px;" data-i18n="exit">Salir</button>
    </div>
  </div>

  <div class="fs" id="fsLB">
    <div class="wrap">
      <div class="titlebar">
        <div class="fs-titlebar-title">Leaderboards</div>
        <button class="back" id="backLB">✖</button>
      </div>
      <div class="card">
        <table class="table" id="lbRounds" style="width:100%;font-size:14px"></table>
        <hr style="border-color:var(--cardBorder);opacity:.5;margin:12px 0"/>
        <table class="table" id="lbTimed" style="width:100%;font-size:14px"></table>
      </div>
    </div>
  </div>

  <div class="fs" id="fsStats" style="display:none;">
    <div class="wrap">
      <div class="titlebar">
        <div class="fs-titlebar-title">Estadísticas y Logros</div>
        <button class="back" id="backStats">✖</button>
      </div>
      <div class="card">
        <h3>Tus Números</h3>
        <div id="statsContainer"></div>
        <hr style="border-color:var(--cardBorder);opacity:.5;margin:12px 0">
        <h3>Logros</h3>
        <div id="achievementsContainer"></div>
      </div>
    </div>
  </div>

  <div class="fs" id="fsVSResult" style="display:none">
    <div class="wrap">
      <div class="titlebar">
        <div class="fs-titlebar-title">Resultados</div>
        <button class="back" id="backVSResult">✖</button>
      </div>
      <div class="card">
        <div class="hero">
          <div class="big-title">—</div>
          <div class="subtitle">—</div>
          <div class="bigscore">0 vs 0</div>
          <div class="actions">
            <button class="btn small" id="btnRematch" type="button">Revancha</button>
            <button class="btn secondary small" id="btnShareResult" type="button">Compartir</button>
            <button class="btn secondary small" id="btnBackHome" type="button">Inicio</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="fs" id="fsSingleResult" style="display:none">
    <div class="wrap">
      <div class="titlebar">
        <div class="fs-titlebar-title">Resultados</div>
        <button class="back" id="backSingleResult">✖</button>
      </div>
      <div class="card">
        <div class="hero">
          <div class="big-title" id="srTitle">—</div>
          <div class="subtitle" id="srSubtitle">—</div>
          <div class="bigscore" id="srScore">—</div>
          <div class="actions">
            <button class="btn small" id="srAgain" type="button">Jugar de nuevo</button>
            <button class="btn secondary small" id="srHome" type="button">Inicio</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pantalla del Modo Aventura -->
  <div class="fs fs-adventure" id="fsAdventure">
    <div class="adventure-container">
      <div id="adventureMapContainer">
        <!-- Aquí se renderizará el mapa de aventura -->
      </div>
    </div>
  </div>
  
  <!-- Área de juego de aventura -->
  <div id="adventureGameArea">
    <!-- Aquí se renderizará el juego de aventura -->
  </div>

  <div class="modal" id="profileModal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:800" data-i18n="yourProfile">Tu Perfil</div>
        <button class="iconbtn" id="btnCloseProfile" type="button">✖</button>
      </div>
      <div class="profile-header-horizontal">
        <img src="img/avatar_placeholder.svg" alt="Avatar" class="profile-avatar-large" id="profileAvatar"/>
        <div class="profile-info">
          <div class="profile-nickname" id="profileNicknameText">—</div>
          <div class="level-badge" id="profileLevelBadge"><span data-i18n="level">Nivel</span> 1</div>
          <div class="xp-bar-container">
            <div class="xp-bar" id="profileXpBar"></div>
            <div class="xp-text" id="profileXpText">0 / 100 XP</div>
          </div>
        </div>
      </div>
      
      <!-- Botones de acción (más pequeños) -->
      <div class="profile-section" id="profileActionsSection" style="display:none">
        <div class="row" style="gap: 8px;">
          <button class="btn secondary small" id="profileBtnStats" style="flex:1" data-i18n="statsAndAchievements">Estadísticas</button>
          <button class="btn secondary danger small" id="profileBtnLogout" style="flex:1">Cerrar Sesión</button>
        </div>
      </div>
      
      <!-- Sección de auth para no logueados -->
      <div class="profile-section" id="profileAuthSection" style="display:none">
        <div style="text-align:center; padding: 16px 0;">
          <p style="margin: 0 0 16px; color: var(--muted);">Inicia sesión para guardar tu progreso</p>
          <button class="btn accent" id="profileBtnAuth" style="width:100%">Iniciar Sesión / Registrarse</button>
        </div>
      </div>
      <div class="profile-section">
        <h4 data-i18n="purchases">Compras</h4>
        <div class="bank-info" id="profileBankInfo">Base: 300</div>
        <div class="empty-state" data-i18n="purchasesEmpty">Aquí aparecerán los packs que compres.</div>
      </div>
      <div class="profile-section">
        <h4 data-i18n="plan">Plan</h4>
        <div class="empty-state" data-i18n="planFree">Actualmente usas el plan Gratuito. ¡Pronto podrás quitar la publicidad!</div>
      </div>
      <div class="profile-section settings-section">
        <h4 data-i18n="settings">Ajustes</h4>
        <div class="row" style="justify-content:space-between">
          <label data-i18n="language">Idioma</label>
          <div class="row">
            <label class="badge">
              <input type="radio" name="language" value="es" checked/> 
              <span data-i18n="spanish">Español</span>
            </label>
            <label class="badge">
              <input type="radio" name="language" value="en"/> 
              <span data-i18n="english">English</span>
            </label>
          </div>
        </div>
        <div class="row" style="justify-content:space-between">
          <label data-i18n="theme">Tema</label>
          <div class="row">
            <label class="badge">
              <input type="radio" name="theme" value="dark" checked/> 
              <span data-i18n="themeDark">Dark</span>
            </label>
            <label class="badge">
              <input type="radio" name="theme" value="light"/> 
              <span data-i18n="themeLight">Claro</span>
            </label>
          </div>
        </div>
        <div class="row" style="justify-content:space-between">
          <label data-i18n="sounds">Sonidos</label>
          <label class="badge">
            <input type="checkbox" id="optSounds" checked/> 
            <span data-i18n="soundsActivate">Activar</span>
          </label>
        </div>
        <div class="row" style="justify-content:space-between">
          <label data-i18n="autoAdvance">Auto Avance</label>
          <label class="badge">
            <input type="checkbox" id="optAutoNextRounds"/> 
            <span data-i18n="soundsActivate">Activar</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPTS OPTIMIZADOS v3.2 - INICIALIZACIÓN ROBUSTA ===== -->
  
  <!-- Librerías externas (primero) -->
  <script id="supabase-umd" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  
  <!-- Core (configuración global) -->
  <script src="./js/core/config.js"></script>
  
  <!-- Scripts del modo aventura (no son módulos ES6) -->
  <script src="./js/adventure/mode.js"></script>
  <script src="./js/adventure/map.js"></script>
  <script src="./js/adventure/game.js"></script>
  <script src="./js/adventure/bosses.js"></script>
  <script src="./js/adventure/bosses_pokemon.js"></script>
  <script src="./js/adventure/init.js"></script>
  
  <!-- Platform specific (no son módulos ES6) -->
  <script src="./js/platform/android-oauth.js"></script>
  <script src="./js/platform/ads.js"></script>
  
  <!-- Script de inicialización robusto -->
  <script>
    (function() {
      'use strict';
      
      console.log('=== Inicialización Robusta v3.2 ===');
      
      // Función para cargar el banco de preguntas manualmente
      async function loadBankFallback() {
        console.log('Cargando banco de preguntas (fallback)...');
        
        try {
          // Cargar el módulo bank.js
          const bankModule = await import('./js/game/bank.js');
          
          // Exponer funciones globalmente
          window.getBank = bankModule.getBank;
          window.setBank = bankModule.setBank;
          window.getBankCount = bankModule.getBankCount;
          window.buildDeckSingle = bankModule.buildDeckSingle;
          window.warmLocalBank = bankModule.warmLocalBank;
          window.ensureBankReady = bankModule.ensureBankReady;
          window.ensureInitial60 = bankModule.ensureInitial60;
          window.BASE_LABELS = bankModule.BASE_LABELS;
          window.BASE_KEYS = bankModule.BASE_KEYS;
          
          // Inicializar el banco
          await bankModule.warmLocalBank('es');
          console.log('✅ Banco cargado:', bankModule.getBankCount(), 'preguntas');
          
          return true;
        } catch (error) {
          console.error('❌ Error cargando banco:', error);
          return false;
        }
      }
      
      // Función para cargar los módulos principales
      async function loadMainModules() {
        console.log('Cargando módulos principales...');
        
        try {
          // Primero asegurar que el banco esté listo
          if (!window.getBank) {
            await loadBankFallback();
          }
          
          // Cargar bank_bridge
          await import('./js/game/bank_bridge.js');
          
          // Cargar DLC store
          await import('./js/store/dlc.js');
          
          // Finalmente cargar main.js
          await import('./js/main.js?v=' + Date.now());
          
          console.log('✅ Todos los módulos cargados');
          return true;
        } catch (error) {
          console.error('❌ Error cargando módulos:', error);
          return false;
        }
      }
      
      // Iniciar cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadMainModules);
      } else {
        // DOM ya está listo
        setTimeout(loadMainModules, 100);
      }
      
    })();
  </script>
</body>
</html>
