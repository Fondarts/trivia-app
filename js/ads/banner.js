// js/ads/banner.js
// Sistema de Banner para AdMob

import { AD_CONFIG } from './config.js';

export class BannerAd {
  constructor() {
    this.isLoaded = false;
    this.isVisible = false;
    this.isInitializing = false;
    this.lastShowAttempt = 0;
  }

  // Inicializar AdMob
  async initialize() {
    // Solo funcionar en Android
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      console.log('üì± AdMob solo funciona en Android');
      return false;
    }

    try {
      // Verificar si AdMob est√° disponible globalmente
      if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob) {
        const AdMob = window.Capacitor.Plugins.AdMob;
        
        console.log('üîç Inicializando AdMob con configuraci√≥n:', {
          initializeForTesting: AD_CONFIG.IS_TESTING,
          appId: 'ca-app-pub-7829392929574421~4523784771'
        });

        const initResult = await AdMob.initialize({
          initializeForTesting: AD_CONFIG.IS_TESTING,
          requestTrackingAuthorization: true
        });
        
        console.log('üîç Resultado de inicializaci√≥n:', initResult);
        
        // Agregar listeners para eventos de banner
        AdMob.addListener('bannerAdLoaded', () => {
          console.log('üéâ Banner cargado exitosamente');
          this.isLoaded = true;
        });
        
        AdMob.addListener('bannerAdFailedToLoad', (error) => {
          console.error('‚ùå Banner fall√≥ al cargar:', error);
          console.error('üîç C√≥digo de error:', error.code);
          console.error('üîç Mensaje de error:', error.message);
          this.isLoaded = false;
        });
        
        AdMob.addListener('bannerAdShown', () => {
          console.log('üëÅÔ∏è Banner mostrado');
          this.isVisible = true;
        });
        
        AdMob.addListener('bannerAdHidden', () => {
          console.log('üôà Banner oculto');
          this.isVisible = false;
        });
        
        AdMob.addListener('bannerAdClicked', () => {
          console.log('üëÜ Banner clickeado');
        });
        
        AdMob.addListener('bannerAdImpression', () => {
          console.log('üëÄ Banner impresi√≥n registrada');
        });
        
        console.log('‚úÖ AdMob inicializado correctamente');
        return true;
      } else {
        console.log('‚ö†Ô∏è AdMob plugin no disponible');
        console.log('üîç Plugins disponibles:', Object.keys(window.Capacitor.Plugins || {}));
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error inicializando AdMob:', error);
      console.error('Detalles del error:', error.message);
      return false;
    }
  }

  // Mostrar Banner
  async showBanner() {
    // Solo funcionar en Android
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      return false;
    }

    // Evitar llamadas duplicadas (m√°ximo una cada 5 segundos)
    const now = Date.now();
    if (now - this.lastShowAttempt < 5000) {
      console.log('‚ö†Ô∏è Banner ya se intent√≥ mostrar recientemente, saltando...');
      return this.isVisible;
    }
    this.lastShowAttempt = now;

    // Si ya est√° visible, no hacer nada
    if (this.isVisible) {
      console.log('‚úÖ Banner ya est√° visible');
      return true;
    }

    try {
      // Usar AdMob desde plugins globales
      if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob) {
        const AdMob = window.Capacitor.Plugins.AdMob;
        
        // Limpiar banner existente antes de mostrar uno nuevo
        try {
          await AdMob.removeBanner();
          console.log('üßπ Banner anterior removido');
        } catch (removeError) {
          console.log('‚ÑπÔ∏è No hab√≠a banner anterior que remover');
        }
        
        console.log('üîç Mostrando banner con configuraci√≥n:', {
          adId: AD_CONFIG.BANNER_ID,
          adSize: 'BANNER',
          position: 'BOTTOM_CENTER',
          margin: 0,
          isTesting: AD_CONFIG.IS_TESTING
        });

        const result = await AdMob.showBanner({
          adId: AD_CONFIG.BANNER_ID,
          adSize: 'BANNER',
          position: 'BOTTOM_CENTER',
          margin: 0,
          isTesting: AD_CONFIG.IS_TESTING
        });
        
        console.log('üîç Resultado de showBanner:', result);
        
        // Esperar un poco para que el banner se renderice
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Verificar si realmente se mostr√≥
        if (result === true) {
          this.isLoaded = true;
          this.isVisible = true;
          console.log('‚úÖ Banner mostrado correctamente');
        } else {
          console.log('‚ö†Ô∏è Banner no se pudo mostrar, resultado:', result);
        }
        
        return result === true;
      } else {
        console.log('‚ö†Ô∏è AdMob plugin no disponible para mostrar banner');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error mostrando banner:', error);
      return false;
    }
  }

  // Ocultar Banner
  async hideBanner() {
    // Solo funcionar en Android
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      return false;
    }

    try {
      // Usar AdMob desde plugins globales
      if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob) {
        const AdMob = window.Capacitor.Plugins.AdMob;
        
        await AdMob.hideBanner();
        this.isVisible = false;
        console.log('‚úÖ Banner ocultado');
        return true;
      } else {
        console.log('‚ö†Ô∏è AdMob plugin no disponible para ocultar banner');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error ocultando banner:', error);
      return false;
    }
  }

  // Remover Banner completamente
  async removeBanner() {
    // Solo funcionar en Android
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      return false;
    }

    try {
      // Usar AdMob desde plugins globales
      if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob) {
        const AdMob = window.Capacitor.Plugins.AdMob;
        
        await AdMob.removeBanner();
        this.isLoaded = false;
        this.isVisible = false;
        console.log('‚úÖ Banner removido');
        return true;
      } else {
        console.log('‚ö†Ô∏è AdMob plugin no disponible para remover banner');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error removiendo banner:', error);
      return false;
    }
  }

  // Verificar si est√° visible
  isBannerVisible() {
    return this.isVisible;
  }

  // Verificar si est√° cargado
  isBannerLoaded() {
    return this.isLoaded;
  }

  // Funci√≥n de test completo
  async testCompleteBanner() {
    console.log('üß™ Iniciando test completo de banner...');
    
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      console.log('‚ùå No es Android, no se puede testear');
      return false;
    }

    try {
      const AdMob = window.Capacitor.Plugins.AdMob;
      
      // Test 1: Verificar que el plugin existe
      console.log('üîç Test 1 - Plugin disponible:', !!AdMob);
      
      // Test 2: Verificar m√©todos disponibles
      console.log('üîç Test 2 - M√©todos disponibles:', Object.keys(AdMob));
      
      // Test 3: Verificar permisos
      console.log('üîç Test 3 - Verificando permisos...');
      try {
        const permissions = await AdMob.checkPermissions();
        console.log('üîç Permisos actuales:', permissions);
      } catch (error) {
        console.log('‚ö†Ô∏è Error verificando permisos:', error);
      }
      
      // Test 4: Solicitar permisos si es necesario
      console.log('üîç Test 4 - Solicitando permisos...');
      try {
        const requestResult = await AdMob.requestPermissions();
        console.log('üîç Resultado de solicitud de permisos:', requestResult);
      } catch (error) {
        console.log('‚ö†Ô∏è Error solicitando permisos:', error);
      }
      
      // Test 5: Verificar estado de tracking
      console.log('üîç Test 5 - Verificando estado de tracking...');
      try {
        const trackingStatus = await AdMob.trackingAuthorizationStatus();
        console.log('üîç Estado de tracking:', trackingStatus);
      } catch (error) {
        console.log('‚ö†Ô∏è Error verificando tracking:', error);
      }
      
      // Test 6: Intentar mostrar banner con diferentes configuraciones
      console.log('üîç Test 6 - Probando diferentes configuraciones...');
      
      const testConfigs = [
        {
          name: 'Google Test ID',
          config: {
            adId: 'ca-app-pub-3940256099942544/6300978111',
            adSize: 'BANNER',
            position: 'BOTTOM_CENTER',
            margin: 0,
            isTesting: true
          }
        },
        {
          name: 'Tu ID con testing',
          config: {
            adId: 'ca-app-pub-7829392929574421/5868656038',
            adSize: 'BANNER',
            position: 'BOTTOM_CENTER',
            margin: 0,
            isTesting: true
          }
        },
        {
          name: 'Tu ID sin testing',
          config: {
            adId: 'ca-app-pub-7829392929574421/5868656038',
            adSize: 'BANNER',
            position: 'BOTTOM_CENTER',
            margin: 0,
            isTesting: false
          }
        }
      ];
      
      for (const test of testConfigs) {
        console.log(`üîç Probando: ${test.name}`);
        try {
          const result = await AdMob.showBanner(test.config);
          console.log(`‚úÖ ${test.name} - Resultado:`, result);
          
          if (result === true) {
            console.log(`üéâ ${test.name} funcion√≥!`);
            return true;
          }
        } catch (error) {
          console.log(`‚ùå ${test.name} - Error:`, error);
        }
      }
      
      console.log('‚ö†Ô∏è Ninguna configuraci√≥n funcion√≥');
      return false;
    } catch (error) {
      console.error('‚ùå Error en test completo:', error);
      return false;
    }
  }

  // Funci√≥n de test con IDs de Google
  async testGoogleBanner() {
    console.log('üß™ Iniciando test con IDs de Google...');
    
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      console.log('‚ùå No es Android, no se puede testear');
      return false;
    }

    try {
      const AdMob = window.Capacitor.Plugins.AdMob;
      
      // Test 1: Verificar que el plugin existe
      console.log('üîç Test 1 - Plugin disponible:', !!AdMob);
      
      // Test 2: Verificar m√©todos disponibles
      console.log('üîç Test 2 - M√©todos disponibles:', Object.keys(AdMob));
      
      // Test 3: Intentar mostrar banner con ID de test de Google
      console.log('üîç Test 3 - Mostrando banner con ID de test de Google...');
      console.log('üîç Test 3 - Banner ID:', 'ca-app-pub-3940256099942544/6300978111');
      console.log('üîç Test 3 - App ID en config:', 'ca-app-pub-3940256099942544~3347511713');
      
      const result = await AdMob.showBanner({
        adId: 'ca-app-pub-3940256099942544/6300978111', // ID de test de Google
        adSize: 'BANNER',
        position: 'BOTTOM_CENTER',
        margin: 0,
        isTesting: true
      });
      
      console.log('üîç Test 3 - Resultado:', result);
      console.log('üîç Test 3 - Tipo de resultado:', typeof result);
      
      if (result === undefined) {
        console.log('‚ö†Ô∏è El plugin devuelve undefined - posible problema de configuraci√≥n');
        console.log('üí° Esto puede ser normal en algunos casos, el banner puede aparecer igual');
      } else if (result === true) {
        console.log('‚úÖ El plugin devuelve true - banner deber√≠a estar visible');
      } else if (result === false) {
        console.log('‚ùå El plugin devuelve false - banner fall√≥');
      } else {
        console.log('ü§î El plugin devuelve algo inesperado:', result);
      }
      
      // Esperar un poco para ver si aparecen eventos
      console.log('üîç Esperando eventos de banner...');
      await new Promise(resolve => setTimeout(resolve, 3000));
      
      return true;
    } catch (error) {
      console.error('‚ùå Error en test de Google:', error);
      return false;
    }
  }

  // Funci√≥n de test simple
  async testSimpleBanner() {
    console.log('üß™ Iniciando test simple de banner...');
    
    if (!window.Capacitor || window.Capacitor.getPlatform() !== 'android') {
      console.log('‚ùå No es Android, no se puede testear');
      return false;
    }

    try {
      const AdMob = window.Capacitor.Plugins.AdMob;
      
      // Test 1: Verificar que el plugin existe
      console.log('üîç Test 1 - Plugin disponible:', !!AdMob);
      
      // Test 2: Verificar m√©todos disponibles
      console.log('üîç Test 2 - M√©todos disponibles:', Object.keys(AdMob));
      
      // Test 3: Intentar mostrar banner con configuraci√≥n m√≠nima
      console.log('üîç Test 3 - Mostrando banner con configuraci√≥n m√≠nima...');
      
      const result = await AdMob.showBanner({
        adId: 'ca-app-pub-3940256099942544/6300978111', // ID de test de Google
        adSize: 'BANNER',
        position: 'BOTTOM_CENTER',
        margin: 0,
        isTesting: true
      });
      
      console.log('üîç Test 3 - Resultado:', result);
      console.log('üîç Test 3 - Tipo de resultado:', typeof result);
      
      if (result === undefined) {
        console.log('‚ö†Ô∏è El plugin devuelve undefined - posible problema de configuraci√≥n');
        console.log('üí° Esto puede ser normal en algunos casos, el banner puede aparecer igual');
      } else if (result === true) {
        console.log('‚úÖ El plugin devuelve true - banner deber√≠a estar visible');
      } else if (result === false) {
        console.log('‚ùå El plugin devuelve false - banner fall√≥');
      } else {
        console.log('ü§î El plugin devuelve algo inesperado:', result);
      }
      
      return true;
    } catch (error) {
      console.error('‚ùå Error en test simple:', error);
      return false;
    }
  }

  // Funci√≥n de debug para verificar estado
  async debugBannerStatus() {
    console.log('üîç Estado del banner:', {
      isLoaded: this.isLoaded,
      isVisible: this.isVisible,
      isAndroid: window.Capacitor && window.Capacitor.getPlatform() === 'android',
      hasAdMobPlugin: !!(window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob)
    });

    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.AdMob) {
      try {
        const AdMob = window.Capacitor.Plugins.AdMob;
        console.log('üîç Plugin AdMob disponible:', AdMob);
        
        // Intentar obtener el estado del banner
        if (AdMob.getBannerViewInfo) {
          const bannerInfo = await AdMob.getBannerViewInfo();
          console.log('üîç Informaci√≥n del banner:', bannerInfo);
        }
      } catch (error) {
        console.error('‚ùå Error obteniendo estado del banner:', error);
      }
    }
  }
}
