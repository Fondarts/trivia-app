<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Quizle</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #0f4c75;
        }
        .test-result {
            padding: 10px;
            background: #0f3460;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #e94560;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #c23651;
        }
    </style>
</head>
<body>
    <h1>Test de Funcionalidad - Quizle</h1>
    
    <div class="test-section">
        <div class="test-title">1. Verificación de Módulos</div>
        <div id="modules-test" class="test-result">Verificando...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">2. Banco de Preguntas</div>
        <div id="bank-test" class="test-result">Verificando...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">3. Categorías Disponibles</div>
        <div id="categories-test" class="test-result">Verificando...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">4. Funciones Principales</div>
        <div id="functions-test" class="test-result">Verificando...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">5. Acciones de Prueba</div>
        <button onclick="testBuildDeck()">Crear Deck de Prueba</button>
        <button onclick="testLoadCategories()">Cargar Categorías</button>
        <button onclick="testClearStorage()">Limpiar Storage</button>
        <button onclick="window.location.href='index.html'">Ir a la App</button>
        <div id="action-result" class="test-result" style="margin-top: 10px;"></div>
    </div>

    <script>
        // Test 1: Verificar módulos
        function testModules() {
            const result = document.getElementById('modules-test');
            const modules = [
                'window.getBank',
                'window.setBank',
                'window.getBankCount',
                'window.buildDeckSingle',
                'window.BASE_LABELS',
                'window.BASE_KEYS'
            ];
            
            let html = '';
            let allOk = true;
            
            modules.forEach(mod => {
                const exists = eval(`typeof ${mod} !== 'undefined'`);
                html += `<div class="${exists ? 'success' : 'error'}">${mod}: ${exists ? '✓' : '✗'}</div>`;
                if (!exists) allOk = false;
            });
            
            result.innerHTML = html;
            return allOk;
        }
        
        // Test 2: Verificar banco
        function testBank() {
            const result = document.getElementById('bank-test');
            try {
                const bank = JSON.parse(localStorage.getItem('trivia_bank') || '{}');
                const categories = Object.keys(bank);
                let totalQuestions = 0;
                
                let html = '';
                categories.forEach(cat => {
                    const count = bank[cat] ? bank[cat].length : 0;
                    totalQuestions += count;
                    html += `<div>${cat}: ${count} preguntas</div>`;
                });
                
                html = `<div class="success">Total: ${totalQuestions} preguntas</div>` + html;
                result.innerHTML = html;
                
                return totalQuestions > 0;
            } catch (e) {
                result.innerHTML = `<div class="error">Error: ${e.message}</div>`;
                return false;
            }
        }
        
        // Test 3: Verificar categorías
        function testCategories() {
            const result = document.getElementById('categories-test');
            try {
                if (typeof window.BASE_LABELS === 'undefined') {
                    result.innerHTML = '<div class="warning">BASE_LABELS no está definido aún</div>';
                    return false;
                }
                
                const labels = window.BASE_LABELS;
                let html = '';
                Object.entries(labels).forEach(([key, label]) => {
                    html += `<div class="success">${key}: ${label}</div>`;
                });
                result.innerHTML = html;
                return true;
            } catch (e) {
                result.innerHTML = `<div class="error">Error: ${e.message}</div>`;
                return false;
            }
        }
        
        // Test 4: Verificar funciones
        function testFunctions() {
            const result = document.getElementById('functions-test');
            const tests = [];
            
            // Test getBank
            try {
                if (window.getBank) {
                    const bank = window.getBank();
                    tests.push({ name: 'getBank()', success: typeof bank === 'object' });
                } else {
                    tests.push({ name: 'getBank()', success: false, error: 'No definida' });
                }
            } catch (e) {
                tests.push({ name: 'getBank()', success: false, error: e.message });
            }
            
            // Test getBankCount
            try {
                if (window.getBankCount) {
                    const count = window.getBankCount();
                    tests.push({ name: `getBankCount()`, success: true, value: count });
                } else {
                    tests.push({ name: 'getBankCount()', success: false, error: 'No definida' });
                }
            } catch (e) {
                tests.push({ name: 'getBankCount()', success: false, error: e.message });
            }
            
            // Mostrar resultados
            let html = '';
            tests.forEach(test => {
                const className = test.success ? 'success' : 'error';
                const value = test.value !== undefined ? ` = ${test.value}` : '';
                const error = test.error ? ` (${test.error})` : '';
                html += `<div class="${className}">${test.name}${value}${error}: ${test.success ? '✓' : '✗'}</div>`;
            });
            
            result.innerHTML = html;
            return tests.every(t => t.success);
        }
        
        // Acciones de prueba
        function testBuildDeck() {
            const result = document.getElementById('action-result');
            try {
                if (!window.buildDeckSingle) {
                    result.innerHTML = '<div class="error">buildDeckSingle no está disponible</div>';
                    return;
                }
                
                const deck = window.buildDeckSingle('movies', 5, 'easy');
                result.innerHTML = `<div class="success">Deck creado con ${deck.length} preguntas:</div>`;
                deck.forEach((q, i) => {
                    result.innerHTML += `<div>${i+1}. ${q.q || q.question || 'Sin pregunta'}</div>`;
                });
            } catch (e) {
                result.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        function testLoadCategories() {
            const result = document.getElementById('action-result');
            try {
                const bank = window.getBank ? window.getBank() : JSON.parse(localStorage.getItem('trivia_bank') || '{}');
                const categories = Object.keys(bank).filter(k => bank[k] && bank[k].length > 0);
                
                if (categories.length > 0) {
                    result.innerHTML = `<div class="success">Categorías con contenido:</div>`;
                    categories.forEach(cat => {
                        result.innerHTML += `<div>• ${cat}: ${bank[cat].length} preguntas</div>`;
                    });
                } else {
                    result.innerHTML = '<div class="warning">No hay categorías con preguntas</div>';
                }
            } catch (e) {
                result.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        function testClearStorage() {
            if (confirm('¿Seguro que quieres limpiar todo el localStorage? Esto borrará todos los datos guardados.')) {
                localStorage.clear();
                document.getElementById('action-result').innerHTML = '<div class="success">LocalStorage limpiado. Recarga la página.</div>';
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        // Ejecutar tests cuando el banco esté listo
        function runAllTests() {
            console.log('Ejecutando todos los tests...');
            testModules();
            testBank();
            testCategories();
            testFunctions();
        }
        
        // Esperar a que el banco esté listo
        if (window.getBank && window.getBankCount) {
            runAllTests();
        } else {
            document.getElementById('modules-test').innerHTML = '<div class="warning">Esperando a que se carguen los módulos...</div>';
            
            // Intentar cargar el banco directamente
            const script = document.createElement('script');
            script.type = 'module';
            script.textContent = `
                import('./js/game/bank.js').then(module => {
                    window.getBank = module.getBank;
                    window.setBank = module.setBank;
                    window.getBankCount = module.getBankCount;
                    window.buildDeckSingle = module.buildDeckSingle;
                    window.BASE_LABELS = module.BASE_LABELS;
                    window.BASE_KEYS = module.BASE_KEYS;
                    
                    // Inicializar banco
                    module.warmLocalBank('es').then(() => {
                        console.log('Banco cargado desde test');
                        runAllTests();
                    });
                }).catch(err => {
                    console.error('Error cargando módulo:', err);
                    document.getElementById('modules-test').innerHTML = '<div class="error">Error cargando módulos: ' + err.message + '</div>';
                });
            `;
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
